{% extends "base.html" %} {% block content %}
<div class="row">
  <div class="col-md-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'activities' %}"> Activities </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          {{ activity.name }}
        </li>
      </ol>
    </nav>

    <h1>{{ activity.name }}</h1>
    <p class="text-muted">
      {{ activity.start_date_local|date:"l, F d, Y \a\t h:i A" }}
    </p>
  </div>
</div>

<div class="row mt-4">
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Activity Details</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6">
            <p class="mb-1"><strong>Distance:</strong></p>
            <h4>{{ activity.distance_km|floatformat:2 }} km</h4>
          </div>
          <div class="col-6">
            <p class="mb-1"><strong>Moving Time:</strong></p>
            <h4>{{ activity.moving_time_formatted }}</h4>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-6">
            <p class="mb-1"><strong>Elevation Gain:</strong></p>
            <h4>{{ activity.total_elevation_gain|floatformat:0 }} m</h4>
          </div>
          <div class="col-6">
            <p class="mb-1"><strong>Average Speed:</strong></p>
            <h4>{{ activity.average_speed_kmh|floatformat:1 }} km/h</h4>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">Map</div>
      <div class="card-body">
        <div id="activityMap" style="height: 300px; width: 100%; border-radius: 8px;"></div>
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
            <script>
            // Función para decodificar polilíneas de Google (usadas por Strava)
            function decodePolyline(encoded) {
                if (!encoded) return [];
                var points = [];
                var index = 0, len = encoded.length;
                var lat = 0, lng = 0;
                while (index < len) {
                    var b, shift = 0, result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    var dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lat += dlat;
                    shift = 0;
                    result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    var dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lng += dlng;
                    points.push([lat / 1e5, lng / 1e5]);
                }
                return points;
            }

            document.addEventListener('DOMContentLoaded', function() {
              var encodedPolyline = "{{ activity.summary_polyline|safe }}";
              
              if (encodedPolyline && encodedPolyline !== "None" && encodedPolyline !== "") {
                var coordinates = decodePolyline(encodedPolyline);
                
                var map = L.map('activityMap');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  maxZoom: 18,
                  attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                var route = L.polyline(coordinates, {
                  color: '#ff4400',
                  weight: 4,
                  opacity: 0.8,
                  lineJoin: 'round'
                }).addTo(map);

                map.fitBounds(route.getBounds(), { padding: [20, 20] });
              } else {
                var start_latlng = {{ activity.start_latlng|safe|default:"null" }};
                if (!start_latlng) {
                    start_latlng = [19.4326, -99.1332]; // Default CDMX
                }
                var map = L.map('activityMap').setView(start_latlng, 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  maxZoom: 18,
                  attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                L.marker(start_latlng).addTo(map)
                  .bindPopup('Start Point')
                  .openPopup();
              }
            });
            </script>
      </div>
    </div>
  </div>
</div>

{% if similar_activities %}
<div class="row mt-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          Comparison with Similar Activities ({{ activity.type }})
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th>Date</th>
                <th>Distance (km)</th>
                <th>Time</th>
                <th>Avg Speed (km/h)</th>
                <th>Elevation (m)</th>
              </tr>
            </thead>
            <tbody>
              {% for similar in similar_activities %}
              <tr>
                <td>
                  <a href="{% url 'activity_detail' similar.id %}">
                    {{ similar.start_date_local|date:"Y-m-d" }}
                  </a>
                </td>
                <td>{{ similar.distance_km|floatformat:2 }}</td>
                <td>{{ similar.moving_time_formatted }}</td>
                <td>{{ similar.average_speed_kmh|floatformat:1 }}</td>
                <td>{{ similar.total_elevation_gain|floatformat:0 }}</td>
              </tr>
              {% endfor %}

              <tr class="table-primary">
                <td>
                  <strong
                    >{{ activity.start_date_local|date:"Y-m-d" }}</strong
                  >
                </td>
                <td>
                  <strong>{{ activity.distance_km|floatformat:2 }}</strong>
                </td>
                <td><strong>{{ activity.moving_time_formatted }}</strong></td>
                <td>
                  <strong
                    >{{ activity.average_speed_kmh|floatformat:1 }}</strong
                  >
                </td>
                <td>
                  <strong
                    >{{ activity.total_elevation_gain|floatformat:0 }}</strong
                  >
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endblock %}
